<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <script src='d3.v3.min.js'></script>
    <title>Doughnut</title>
</head>
<body>
<div id='doughnut'></div>
<script>
    (function (d3) {
        var data = [];
        var data_is_available = false;
        d3.json('processed.json', function (records) {
            records.sort(function (a, b) {
                if (a['current'] < b['current']) {
                    return -1;
                } else if (a['current'] == b['current']) {
                    return 0;
                } else {
                    return 1;
                }
            });
            records.forEach(function (currentValue) {
                data.push(currentValue['current']);
            });
            data_is_available = true;
            draw();
        });

        // The function that actually draws the graph
        // Should only be called after the data array has been initialized
        function draw() {
            var width = window.innerWidth;
            var height = window.innerHeight;
            var radius = Math.min(width, height) / 2;
            // Remove the old SVG, if it exists
            d3.select('svg').remove();
            var svg = d3.select('#doughnut')
                    .append('svg').attr('width', width).attr('height', height)
                    .append('g').attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

            var pie = d3.layout.pie();

            var arc = d3.svg.arc().innerRadius(0.4 * radius).outerRadius(0.8 * radius);

            // Store one category instead of creating many.
            var color = d3.scale.category20b();

            var path = svg.selectAll('path')
                    .data(pie(data))
                    .enter()
                    .append('path')
                    .attr('d', arc)
                    .attr('fill', function (d) {
                        return color(d.data);
                    });
        }

        /**
         * This function calls draw() to redraw the graph if the data is available.
         */
        function redraw() {
            if (data_is_available) {
                draw();
            }
        }

        window.addEventListener('resize', redraw);
    })(window.d3);
</script>
</body>
</html>
